load("//constraints:defs.bzl", "transition_alias")
load(":defs.bzl", "SYSROOT_CRATES", "rust_dist", "rust_tool", "sysroot")

[
    transition_alias(
        name = crate,
        actual = "//:{}".format(crate),
        incoming_transition = "//platforms/stage1:library",
        visibility = ["PUBLIC"],
    )
    for crate in SYSROOT_CRATES
]

# NVPTX variants of the sysroot crates so we can build a GPU sysroot.
[
    transition_alias(
        name = "{}__nvptx".format(crate),
        actual = "//:{}".format(crate),
        incoming_transition = "//platforms/nvptx:library",
        visibility = ["PUBLIC"],
    )
    for crate in SYSROOT_CRATES
]

transition_alias(
    name = "rust_allocator",
    actual = "//allocator:rust_allocator",
    incoming_transition = "//platforms/stage1:library",
    visibility = ["toolchains//:rust"],
)

rust_tool(
    name = "rustc",
    exe = "//:rustc-main-rustc-main",
    incoming_transition = "//platforms/stage1:compiler",
    llvm = "//stage0:ci_llvm",
    visibility = [
        "toolchains//:rust",
        "toolchains//:rust_nvptx",
        "toolchains//:rust_nvptx_sysroot",
        "toolchains//:rust_nvptx_full",
    ],
)

rust_tool(
    name = "rustdoc",
    exe = "//:rustdoc-tool-rustdoc_tool_binary",
    incoming_transition = "//platforms/stage1:compiler",
    llvm = "//stage0:ci_llvm",
    visibility = [
        "toolchains//:rust",
        "toolchains//:rust_nvptx",
        "toolchains//:rust_nvptx_sysroot",
        "toolchains//:rust_nvptx_full",
    ],
)

rust_tool(
    name = "clippy-driver",
    exe = "//:clippy-clippy-driver",
    incoming_transition = "//platforms/stage1:compiler",
    llvm = "//stage0:ci_llvm",
    visibility = [
        "toolchains//:rust",
        "toolchains//:rust_nvptx",
        "toolchains//:rust_nvptx_sysroot",
        "toolchains//:rust_nvptx_full",
    ],
)

sysroot(
    name = "sysroot",
    incoming_transition = "//platforms/stage1:library",
    visibility = ["toolchains//:rust"],
    deps = [":{}".format(crate) for crate in SYSROOT_CRATES],
)

# Sysroot built for the nvptx platform using the nvptx toolchain.
sysroot(
    name = "sysroot_nvptx",
    incoming_transition = "//platforms/nvptx:library",
    rust_toolchain = "toolchains//:rust_nvptx",
    visibility = ["PUBLIC"],
    # Minimal nvptx sysroot: core/alloc/compiler_builtins/panic_abort/std only.
    deps = [
        ":core__nvptx",
        ":alloc__nvptx",
        ":compiler_builtins__nvptx",
        ":panic_abort__nvptx",
        ":std__nvptx",
    ],
)

sysroot(
    name = "sysroot_nvptx_seed",
    incoming_transition = "//platforms/nvptx:library",
    rust_toolchain = "toolchains//:rust_nvptx",
    visibility = ["PUBLIC"],
    deps = [
        ":alloc__nvptx",
        ":compiler_builtins__nvptx",
        ":core__nvptx",
        ":panic_abort__nvptx",
    ],
)

rust_dist(
    name = "dist",
    deps = [
        ":rustc",
        ":sysroot",
        "//stage0:ci_llvm",
    ],
)
